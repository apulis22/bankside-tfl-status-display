<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TFL Status</title>
    <link href="https://fonts.cdnfonts.com/css/london-tube" rel="stylesheet">
    <style>
        body {
            font-family: 'London Tube', Arial, sans-serif;
            background-color: #fff;
            color: #000;
            padding: 24px;
            text-align: center;
            font-size: 24px;
        }

        h1,
        h2 {
            font-family: 'London Tube', Arial, sans-serif;
            margin: 24px 0 24px;
        }

        h1 {
            font-size: 36px;
        }

        h2 {
            font-size: 30px;
            margin: 16px 0 16px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 0 auto;
        }

        .status-item {
            break-inside: avoid;
            padding: 12px;
            border-radius: 6px;
            background: #f1f1f1;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        .status-item.disrupted {
            background: #fbbcbc86;
        }

        .status-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .status-header {
            display: flex;
            flex-direction: row;
            align-items: center;
            text-align: left;
            gap: 20px;
        }

        .line-name {
            width: 238px;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            color: white;
        }

        .line-status.disrupted {
            color: #c62828;
            font-weight: bold;
        }

        .train-status {
            margin: 0 auto;
            display: flex;
            flex-direction: row;
            gap: 12px;
            justify-content: center;
        }

        .train-status .status-item {
            margin: 12px 0;
        }

        .next-update {
            margin-top: 20px;
            text-align: end;
            font-size: 24px;
            color: #888;
        }
    </style>
</head>

<body>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <h1 id="main-title" style="margin: 0;">TFL Status</h1>
        <div class="next-update" id="next-update" style="margin: 0; text-align: right;">Next update in: 60s</div>
    </div>
    <div id="content"></div>

    <script>
        const tflColors = {
            'Bakerloo': { bg: '#B26300' },
            'Central': { bg: '#DC241F' },
            'Circle': { bg: '#FFC80A', color: '#000' },
            'District': { bg: '#007D32' },
            'Hammersmith & City': { bg: '#F589A6', color: '#0019A8' },
            'Jubilee': { bg: '#838D93' },
            'Metropolitan': { bg: '#9B0058' },
            'Northern': { bg: '#000' },
            'Piccadilly': { bg: '#0019A8' },
            'Victoria': { bg: '#039BE5' },
            'Waterloo & City': { bg: '#76D0BD', color: '#0019A8' },
            'Elizabeth line': { bg: '#60399E' },
            'DLR': { bg: '#00AFAD' },
            'Liberty': { bg: '#5D6061' },
            'Lioness': { bg: '#FAA61A' },
            'Mildmay': { bg: '#0077AD' },
            'Suffragette': { bg: '#5BBD72' },
            'Weaver': { bg: '#823A62' },
            'Windrush': { bg: '#ED1B00' },
        };

        const stations = ['Blackfriars', 'Waterloo', 'London Bridge'];

        let tubeData = [];
        let trainData = [];
        let countdown = 60;
        let showingDisruptions = false;

        const contentContainer = document.getElementById('content');
        const nextUpdateContainer = document.getElementById('next-update');

        async function fetchTubeStatus() {
            const res = await fetch('https://api.tfl.gov.uk/Line/Mode/tube,dlr,overground,elizabeth-line/Status');
            tubeData = await res.json();
        }

        async function fetchTrainStatus() {
            const results = [];
            for (const station of stations) {
                const res = await fetch(`https://api.tfl.gov.uk/StopPoint/Search/${encodeURIComponent(station)}?modes=national-rail`);
                const data = await res.json();
                const match = data.matches?.[0];
                if (!match) continue;

                const stopPointId = match.id;
                const disruptionRes = await fetch(`https://api.tfl.gov.uk/StopPoint/${stopPointId}/Disruption`);
                const disruptions = await disruptionRes.json();

                results.push({ station, disruptions });
            }
            trainData = results;
        }

        function renderOverview() {
            document.getElementById('main-title').textContent = 'TFL Status';
            contentContainer.innerHTML = `
                <h2>Tube Lines</h2>
                <div class="grid-container">${renderTubeLines(false)}</div>
                <h2>Train Stations</h2>
                <div class="train-status">${renderTrainLines(false)}</div>
            `;
        }

        function renderDisruptionsOnly() {
            document.getElementById('main-title').textContent = 'Disruptions';
            // Filter disrupted tube lines
            const disruptedTubeLines = tubeData.filter(line => {
                const statusObj = line.lineStatuses[0];
                return statusObj?.statusSeverity !== 10;
            });

            // Filter disrupted train stations
            const disruptedTrainStations = trainData.filter(item => item.disruptions.length > 0);

            let html = '';

            if (disruptedTubeLines.length > 0) {
                html += `
                    <h2>Tube Lines</h2>
                    <div class="grid-container">${renderTubeLines(true)}</div>
                `;
            }

            if (disruptedTrainStations.length > 0) {
                html += `
                    <h2>Train Stations</h2>
                    <div class="train-status">${renderTrainLines(true)}</div>
                `;
            }

            // If no disruptions at all, show a message
            if (disruptedTubeLines.length === 0 && disruptedTrainStations.length === 0) {
                html += `<div>No disruptions at this time.</div>`;
            }

            contentContainer.innerHTML = html;
        }

        function renderTubeLines(showReason) {
            const displayOrder = [
                'Bakerloo', 'Central', 'Circle', 'District', 'Hammersmith & City', 'Jubilee',
                'Metropolitan', 'Northern', 'Piccadilly', 'Victoria', 'Waterloo & City',
                'Elizabeth line', 'DLR', 'Liberty', 'Lioness', 'Mildmay', 'Suffragette', 'Weaver', 'Windrush'
            ];

            // Sort by displayOrder and filter if needed
            const sorted = tubeData
                .sort((a, b) => displayOrder.indexOf(a.name) - displayOrder.indexOf(b.name))
                .filter(line => !(showReason && line.lineStatuses[0]?.statusSeverity === 10 || !line.lineStatuses[0]));

            // Transpose for column-major order (2 columns)
            const columns = 2;
            const rows = Math.ceil(sorted.length / columns);
            let transposed = [];
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < columns; col++) {
                    const idx = col * rows + row;
                    if (sorted[idx]) transposed.push(sorted[idx]);
                }
            }

            return transposed
                .map(line => {
                    const lineColor = tflColors[line.name] || { bg: '#666' };
                    const statusObj = line.lineStatuses[0];
                    const statusSeverity = statusObj?.statusSeverity;
                    const status = statusObj?.statusSeverityDescription || 'Unknown';
                    let reason = statusObj?.reason || '';
                    reason = reason.replace(/^.*?:\s*/, '');
                    const isDisrupted = statusSeverity !== 10;

                    if (showReason && !isDisrupted) return '';

                    return `
                        <div class="status-item ${isDisrupted ? 'disrupted' : ''} ${showReason && isDisrupted ? 'disruption-detailed' : ''}">
                            <div class="status-content">
                                <div class="status-header">
                                    <span class="line-name" style="background:${lineColor.bg};color:${lineColor.color || '#fff'}">${line.name}</span>
                                    <span class="line-status ${isDisrupted ? 'disrupted' : ''}">${status}</span>
                                </div>
                                ${showReason && reason ? `<div style="text-align: left;">${reason}</div>` : ''}
                            </div>
                        </div>
                    `;
                })
                .join('');
        }

        function renderTrainLines(showReason) {
            return trainData
                .filter(item => !showReason || item.disruptions.length > 0)
                .map(item => {
                    const disruption = item.disruptions[0];
                    const isDisrupted = item.disruptions.length > 0;
                    return `
                        <div class="status-item ${isDisrupted ? 'disrupted' : ''} ${showReason && isDisrupted ? 'disruption-detailed' : ''}">
                            <strong>${item.station}</strong>: ${isDisrupted ? disruption.description : 'Good Service'}
                        </div>
                    `;
                })
                .join('');
        }

        function updateCountdown() {
            if (countdown > 0) {
                countdown--;
                nextUpdateContainer.innerHTML = `Next update in: ${countdown}s`;
            } else {
                updateAll();
                countdown = 60;
            }
        }

        function flipView() {
            showingDisruptions = !showingDisruptions;
            showingDisruptions ? renderDisruptionsOnly() : renderOverview();
        }

        async function updateAll() {
            await fetchTubeStatus();
            await fetchTrainStatus();
            flipView();
        }

        updateAll();
        setInterval(updateCountdown, 1000);
        setInterval(flipView, 15000);
        setInterval(updateAll, 60000);
    </script>
</body>

</html>